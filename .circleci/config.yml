version: 2

jobs:
  build:
    docker:
    - image: cimg/ruby:2.7.6-browsers
      environment:
      - RAILS_ENV: test
      - SELENIUM_CHROME_HEADLESS: true
      - MYSQL_HOST: 127.0.0.1
      - MYSQL_PORT: 3306
      - MYSQL_USERNAME: root
      - MYSQL_PASSWORD: root
      - MYSQL_DATABASE: suikoden_election_2017_test
    - image: cimg/mysql:5.7.38
      environment:
        MYSQL_USER: gss2017
        MYSQL_PASSWORD: gss2017_pasword
        MYSQL_ROOT_PASSWORD: root_password
        MYSQL_PORT: 3306
        MYSQL_DATABASE: suikoden_election_2017_test
    working_directory: ~/repo
    steps:
    - checkout
    - restore_cache:
        keys:
        - v1-dependencies-{{ checksum "Gemfile.lock" }}
        - v1-dependencies-
    - run:
        name: Install system dependencies
        command: |
          sudo apt update
          sudo apt install -y fonts-migmix
    - run:
        name: Install Chrome
        command: |
          sudo apt update --allow-releaseinfo-change
          sudo apt install -y libappindicator3-1
          sudo apt install -y libvulkan1 udev libudev1 libu2f-udev libgbm1 libwayland-server0

          curl -L -o google-chrome.deb https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo dpkg -i google-chrome.deb
          sudo sed -i 's|HERE/chrome\"|HERE/chrome\" --disable-setuid-sandbox|g' /opt/google/chrome/google-chrome
          rm google-chrome.deb
          /opt/google/chrome/google-chrome --version
    - run:
        name: Install appropriate version's Bundler whose number is written in 'Gemfile.lock'
        command: |
          gem install bundler:1.17.3
    - run:
        name: Install gems written in Gemfile
        command: |
          bundle install --jobs=4 --retry=3 --path vendor/bundle
    - run:
        name: Execute yarn install
        command: yarn install
    - save_cache:
        key: v1-dependencies-{{ checksum "Gemfile.lock" }}
        paths:
          - vendor/bundle
    - run:
        name: Wait for booting DBMS
        command: dockerize -wait tcp://127.0.0.1:3306 -timeout 10s
    # TODO: 現状、1,000件 以上あるのでいったんコメントアウト
    # - run:
    #     # db:migrate の前に実行しておかないと Schemafile の ダブルクォート でコケる
    #     name: Execute RuboCop
    #     command: bundle exec rubocop
    - run:
        name: Setup database
        command: bin/rails db:create; bin/rails db:migrate;
    # 現状、rails_helper が無い
    # - run:
    #     name: Run Rails Test
    #     command: |
    #       mkdir /tmp/test-results
    #       bundle exec rspec --format progress \
    #                       $(circleci tests glob "spec/**/*_spec.rb" | circleci tests split --split-by=timings)
    #     when: always # RuboCopは失敗しても通す（WARNING以上は落としてもいいかもしれない）
